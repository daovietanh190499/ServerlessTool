{% extends 'dashboard/base.html' %}

{% block title %}{% if form.instance.pk %}Sửa {{ form.instance.name }}{% else %}Tạo công cụ mới{% endif %}{% endblock %}

{% block extra_css %}
<style>
    .code-editor {
        font-family: monospace;
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>{% if form.instance.pk %}Sửa {{ form.instance.name }}{% else %}Tạo công cụ mới{% endif %}</h2>
    </div>
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            
            <div class="mb-3">
                <label for="{{ form.name.id_for_label }}" class="form-label">Tên công cụ</label>
                {{ form.name.errors }}
                <input type="text" name="{{ form.name.name }}" id="{{ form.name.id_for_label }}" 
                       class="form-control {% if form.name.errors %}is-invalid{% endif %}" 
                       value="{{ form.name.value|default:'' }}" required>
            </div>
            
            <div class="mb-3">
                <label for="{{ form.description.id_for_label }}" class="form-label">Mô tả</label>
                {{ form.description.errors }}
                <textarea name="{{ form.description.name }}" id="{{ form.description.id_for_label }}" 
                          class="form-control {% if form.description.errors %}is-invalid{% endif %}" 
                          rows="3">{{ form.description.value|default:'' }}</textarea>
            </div>
            
            <div class="mb-3">
                <label for="{{ form.python_script.id_for_label }}" class="form-label">Python Script</label>
                {{ form.python_script.errors }}
                <div class="form-text mb-2">Viết script Python của bạn ở đây. Hàm process() là bắt buộc.</div>
                <div id="editor-container">
                    <textarea name="{{ form.python_script.name }}" id="{{ form.python_script.id_for_label }}" 
                              class="form-control code-editor {% if form.python_script.errors %}is-invalid{% endif %}" 
                              rows="15">{{ form.python_script.value|default:'' }}</textarea>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="{{ form.requirements.id_for_label }}" class="form-label">Requirements</label>
                {{ form.requirements.errors }}
                <textarea name="{{ form.requirements.name }}" id="{{ form.requirements.id_for_label }}" 
                          class="form-control {% if form.requirements.errors %}is-invalid{% endif %}" 
                          rows="5">{{ form.requirements.value|default:'' }}</textarea>
                <div class="form-text">Mỗi package trên một dòng</div>
            </div>
            
            <div class="d-flex justify-content-between">
                <a href="{% if form.instance.pk %}{% url 'tool_detail' form.instance.slug %}{% else %}{% url 'tool_list' %}{% endif %}" class="btn btn-secondary">Hủy</a>
                <button type="submit" class="btn btn-primary">Lưu</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
<script>
    // Kiểm tra nếu đang ở trang tạo mới hoặc sửa
    document.addEventListener('DOMContentLoaded', function() {
        // Sử dụng Monaco Editor nếu có thể
        if (typeof require !== 'undefined') {
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' }});
            require(['vs/editor/editor.main'], function() {
                // Lấy nội dung từ textarea
                var textareaElement = document.getElementById('{{ form.python_script.id_for_label }}');
                var container = document.getElementById('editor-container');
                
                // Tạo div cho editor
                var editorDiv = document.createElement('div');
                editorDiv.id = 'monaco-editor';
                editorDiv.style.height = '400px';
                editorDiv.style.border = '1px solid #ddd';
                
                // Thay thế textarea bằng div
                container.innerHTML = '';
                container.appendChild(editorDiv);
                
                // Tạo hidden input để lưu giá trị
                var hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = '{{ form.python_script.name }}';
                hiddenInput.id = '{{ form.python_script.id_for_label }}';
                container.appendChild(hiddenInput);
                
                // Tạo Monaco Editor
                var editor = monaco.editor.create(editorDiv, {
                    value: textareaElement.value,
                    language: 'python',
                    theme: 'vs-dark',
                    automaticLayout: true
                });
                
                // Cập nhật giá trị khi submit form
                var form = document.querySelector('form');
                form.addEventListener('submit', function() {
                    hiddenInput.value = editor.getValue();
                });
            });
        }
    });
</script>
{% endblock %}